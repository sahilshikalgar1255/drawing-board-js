!function(t,i){void 0===i&&(i={});var e=i.insertAt;if(t&&"undefined"!=typeof document){var n=document.head||document.getElementsByTagName("head")[0],s=document.createElement("style");s.type="text/css","top"===e&&n.firstChild?n.insertBefore(s,n.firstChild):n.appendChild(s),s.styleSheet?s.styleSheet.cssText=t:s.appendChild(document.createTextNode(t))}}('.__edb-textarea-box {\n  position: absolute;\n  z-index: 101;\n  width: auto;\n  overflow-y: hidden;\n  overflow-x: hidden;\n  word-wrap: break-word;\n  word-break: break-all;\n  color: #aaa;\n  border: 1px dashed gray;\n}\n.__edb-textarea-box .__edb-textarea {\n  resize: none;\n  background: transparent;\n  border: none;\n  padding: 1px;\n  outline: none;\n  font-family: "PingFang SC", "Microsoft YaHei", "微软雅黑";\n  overflow: hidden;\n}\n.__edb-text-pre {\n  position: absolute;\n  z-index: 999;\n  top: 0;\n  left: -9999px;\n  min-width: 100px;\n  display: inline-block;\n  padding: 1px;\n  border: 1px solid red;\n  font-family: "PingFang SC", "Microsoft YaHei", "微软雅黑";\n}\n.__edb-eraser-hover {\n  cursor: url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAEm0lEQVRYR62XbUxbVRjH/7cUxlrWQW9fBmNsDGROwG1B6C1my5ahERcTTSRMcXIH6NwSv6gxmckMaPywxCXGQTdfMpuMwdiLbI5Fs7HhNCIGlNCOwTbGW3kr76hbJkKPuRdb29tyewDvlyb3Pvf8fs9znnN6LoP/6So0a7QEYdVKKJZNE5fV2jB6nGZohiYoWEzxdii7H7J/b9QYZiKUYcrG8T4ApMTaMF4c7N0lC7yeFqOaDv3rfpYxEVmGBJFnnxrCqd4WKoklCfCbIyMRHjLhDRcEbFNDqBAFhEu+EosW2JNpNIS4ZpxZxgRkGRI9lW6ZHESlw4YDuaniPUuVXVZiUQJ5Jm1sKMM4pPDmyQFUOewiPD3ZKAo0tjplJRYsUJSxMn5GoeyUwn+bGMCZPl+4uyxyEgsSKHhSt8E1S9qlc9400Y9zfTd9Mpd2v5dEsbVhvMT9nFqAN0elgihs0syFJXe+v1UWLlcJKoF8ky6NYUiTNPNfxh2o7r9FBRckmlqHYTljAyH/rY6gArxJy4FhfpZm3jDmwIUBevivbcNiMyavMGK9OgoXB9pACLNPViA/U7+NcbluSOH1Y734ZqCNOvPm9hERvjHCgLy4TeKM1A53oM7Z1TKvQAHHZrmAq1L4T6M9uDTYTg1vuT0qwjeo9R64W+C6szOwAG/SPwvGdVkK/3G0G5cHb1PDbXfHYDltQ5LKH17rvBd4CvgM9nkoUC2F3xjpwrdDd6jhNzsEuB2Jy3V+mQtwgIjL0WcKeE63HSB1Uvj3I134bgHwW53jKKu0IyGclcDvodbZ4bM1BxW4PtyJK8671Jm3d02grNKG+GXB4UIv+Ajk5CAkamTNpemHD7KFKjBgcNXZQQ2/0zOJsgob1oZpZcvuvUt6BPJMWo06XHUhNjElzZS9W1P58dtinPcfi9zhoqN3EqUVdsSFRs1Xdp8t2GcrfiVNFx2uDvs6em1SSmHJlxFh4SrY669AkOAeX4V9L6bIHmw6+6ZEeGxIJHXmHoFCsz4RIcpz+tXrHuEPHVNptAYPzC2xdUsMCl54LKBEV//vKK2wYbVCCvdvuEADMEXbYuojdas27zl4dPnFzz6E6ZndSM182k9iR3osXn3uUZ8xegb/QOkpG6KZlfNlHvRcyOw1a98nhCnZmbtfHPxa1TG89M6RgBJPmePwcnaSGOcY+lOEG6FZNNyzCniOfQ/AR3MSDK5VWeaV2LV1HcybVuFouR0GsiLoOpdtHu9lmM+x7zLAYe9KFH1wAutT0v2mI0avBju9dLjfPsBz2rcA5oi7EvHJT/gICC+4G3NLZAxy18wdPGuH6RouYBNKb/Ic+yaAT3fmHoAg8sWhAvE3UCUy2TiolKH4d28P2nBUAkLQXo7dTwCLICFc0kqc/eQgaf6hxmsXpfsKohYQAnlO9xpAPndXwv1ytaWYNNaeZ0AUu6CYVYMgmeYTbL5mlD0R8RzLA/jKLVFz4rCrvqZcAQUyrPVjjcE6nOZ50DNhPqfLY0DKd+S84ao7e1wBzMZbGya7aQaniQkqMNcT2lwC5vTsA2XESZvzPs3AtDH/ANJxaF2ajW5TAAAAAElFTkSuQmCC") 0 32, auto;\n}\n');class t{static createEl(t="div",{styles:i={},attrs:e={},props:n={}}){let s=document.createElement(t);return Object.keys(i).map((t=>{s.style[t]=i[t]})),Object.keys(e).map((t=>{s.setAttribute(t,e[t])})),Object.keys(n).map((t=>{s[t]=n[t]})),s}static hasClass(t,i){return t.classList.contains(i)}static addClass(t,i){t.classList.add(i)}static removeClass(t,i){t.classList.remove(i)}static setAttr(t,i,e){t.setAttribute(i,e)}static delAttr(t,i){t.removeAttribute(i)}static appendChild(t,i){t.appendChild(i)}static removeChild(t,i){t.removeChild(i)}}function i(t,i){const e=i.canvasWidth,n=i.canvasHeight,s=i.arrowSize;t.save(),t.beginPath(),t.moveTo(i.points[0].x*e,i.points[0].y*n);const o=(t,i,e,n)=>{const s=function(t,i,e){const n=Math.atan2(i.y-t.y,i.x-t.x),s=.6,o=.3,a=e/3*2,r={x:i.x-Math.round(e*Math.cos(n+s)),y:i.y-Math.round(e*Math.sin(n+s))},h={x:i.x-Math.round(e*Math.cos(n-s)),y:i.y-Math.round(e*Math.sin(n-s))},c={x:i.x-Math.round(a*Math.cos(n+o)),y:i.y-Math.round(a*Math.sin(n+o))};return[t,{x:i.x-Math.round(a*Math.cos(n-o)),y:i.y-Math.round(a*Math.sin(n-o))},h,i,r,c]}(e,i,n);((t,i)=>{t.beginPath(),t.moveTo(i[0].x,i[0].y);for(let e=1;e<i.length;e++)t.lineTo(i[e].x,i[e].y);t.closePath(),t.fill()})(t,s)};for(let a=1;a<i.points.length;a++)o(t,{x:i.points[a].x*e,y:i.points[a].y*n},{x:i.points[a-1].x*e,y:i.points[a-1].y*n},s);t.restore()}async function e(t){return new Promise(((i,e)=>{const n=new Image;n.setAttribute("crossOrigin","anonymous"),n.onerror=e,n.onload=()=>i(n),n.src=t}))}function n(i,n,s){return new Promise((async(o,a)=>{const r=i.toDataURL(`image/${s}`),h=t.createEl("canvas",{styles:{width:`${i.width}px`,height:`${i.height}px`},attrs:{width:i.width,height:i.height}}),c=h.getContext("2d"),l=await e(n);!l&&a(),c.drawImage(l,0,0,i.width,i.height);const g=await e(r);!g&&a(),c.drawImage(g,0,0,i.width,i.height),o(h.toDataURL(`image/${s}`))}))}function s(t,i,e,n){const s=t.getBoundingClientRect();return{x:(e-s.left-parseInt(i.paddingLeft)-parseInt(i.borderLeftWidth))*(t.width/parseInt(i.width)),y:(n-s.top-parseInt(i.paddingTop)-parseInt(i.borderTopWidth))*(t.height/parseInt(i.height))}}function o(){return-1!==navigator.language.indexOf("zh")?"Please click to enter":"Type here..."}class a{constructor(){this._event={}}on(t,i){const e=this._event;t in e||(e[t]=[]),e[t].push(i)}off(t,i){const e=this._event;if(!(t in e))return;i||(e[t]=[]);const n=e[t].indexOf(i);n>=0&&e[t].splice(n,1)}trigger(t,i){const e=this._event;if(e[t])for(let n=0;n<e[t].length;n++){e[t][n].call(this,i)}}removeAllListeners(){this._event={}}}class r{constructor(t){const{container:i,bgImg:e="",lineColor:n="#f00",lineWidth:s="1",arrowSize:r=15,eraserSize:h=10,canvasBgColor:c="#fff",textFontSize:l=16,textLineHeight:g=20,textColor:d="#f00",textareaPlaceholder:u=o(),ratio:x=window.devicePixelRatio||1,fontFamily:m="Arial"}=t;if(!i)throw Error("No container element were found...");this.configuration={bgImg:e,ratio:x,lineColor:n,lineWidth:s*x,arrowSize:r*x,eraserSize:h*x,textFontSize:l*x,textLineHeight:g*x,textColor:d,canvasBgColor:c,textareaPlaceholder:u,fontFamily:m},this.container=this.createCanvasOuterBox(i),this.canvas=this.createCanvasEl(this.container,this),this.context=this.canvas.getContext("2d"),this.mode="",this.canvasWidth=this.canvas.width,this.canvasHeight=this.canvas.height,this.originX=null,this.originY=null,this.arrowPoints=[],this.isDrawing=!1,this.image=new Image,this.textareaEl=null,this.measureEl=null,this.historyImage=new Image,this.undoQueue=[],this.redoQueue=[],this.firstDraw=null,this.evt=new a,this.init()}createCanvasOuterBox(i){const e=t.createEl("div",{styles:{height:`${i.clientHeight}px`,width:`${i.clientWidth}px`,position:"relative",top:"0"}});return t.appendChild(i,e),e}createCanvasEl(i,e){const n=t.createEl("canvas",{styles:{height:`${i.clientHeight}px`,width:`${i.clientWidth}px`},attrs:{width:i.clientWidth*e.configuration.ratio,height:i.clientHeight*e.configuration.ratio}});return console.log("Context Ratio :"+e.configuration.ratio),t.appendChild(i,n),n}init(){this.canvas_style=window.getComputedStyle(this.canvas),this.context.lineCap="round",this.clear(),this.setBackground(),this.createTextMeasure(),this.canvas.addEventListener("mousedown",this.mouseDown.bind(this)),this.canvas.addEventListener("mousemove",this.mouseMove.bind(this)),this.canvas.addEventListener("mouseup",this.endOfDrawing.bind(this)),this.canvas.addEventListener("mouseleave",this.endOfDrawing.bind(this))}mouseDown(t){this.isDrawing=!0,this.image.src=this.canvas.toDataURL("image/png"),this.image.crossOrigin="anonymous",this.redoQueue.length=0;const{clientX:i,clientY:e}=t,{x:n,y:o}=s(this.canvas,this.canvas_style,i,e);this.originX=n,this.originY=o,this.ft_originX=this.originX,this.ft_originY=this.originY,this.context.moveTo(this.originX,this.originY),this.context.lineWidth=this.configuration.lineWidth,this.context.strokeStyle=this.configuration.lineColor,this.context.fillStyle=this.configuration.lineColor,this.context.beginPath(),"arrow"===this.mode&&this.saveArrowPoint({x:this.originX,y:this.originY}),"text"===this.mode&&this.createTextArea({x:this.ft_originX,y:this.ft_originY}),this.mode&&"text"!==this.mode&&this.evt.trigger("drawBegin",{x:n,y:o,clientX:i,clientY:e})}mouseMove(t){if(this.isDrawing){const{clientX:i,clientY:e}=t,{x:n,y:o}=s(this.canvas,this.canvas_style,i,e);let a=this.originX,r=this.originY,h=Math.abs(n-this.originX),c=Math.abs(o-this.originY);n<this.originX&&(a=n),o<this.originY&&(r=o);const l={x:n,y:o,originX:this.originY,originY:this.originY,newOriginX:a,newOriginY:r,distanceX:h,distanceY:c,ft_originX:this.ft_originX,ft_originY:this.ft_originY};let g=this.handleMousemove()[this.mode];g&&g(l),this.mode&&"text"!==this.mode&&this.evt.trigger("drawing",{x:n,y:o,clientX:i,clientY:e})}}reDraw(){this.context.clearRect(0,0,this.canvasWidth,this.canvasHeight),this.image.onload=()=>{this.context.drawImage(this.image,0,0)},this.context.beginPath()}endOfDrawing(t){if(this.isDrawing){const{clientX:i,clientY:e}=t,{x:n,y:o}=s(this.canvas,this.canvas_style,i,e);this.context.closePath(),this.isDrawing=!1,this.addHistory(),this.mode&&"text"!==this.mode&&this.evt.trigger("drawEnd",{x:n,y:o,clientX:i,clientY:e})}}addHistory(){let t=this.canvas.toDataURL("image/png");this.undoQueue.push(t);let i=this.undoQueue.length;i>20&&(this.firstDraw=this.undoQueue[0],this.undoQueue=this.undoQueue.slice(-20,i))}setBackground(){this.configuration.bgImg&&(this.context.globalCompositeOperation="destination-out",this.context.fillRect(0,0,this.canvasWidth,this.canvasHeight),this.canvas.style.background=`url(${this.configuration.bgImg})`,this.canvas.style.backgroundSize="100% 100%",this.canvas.style.backgroundPosition="center",this.canvas.style.backgroundRepeat="no-repeat",this.context.globalCompositeOperation="source-over")}handleMousemove(){return{pencil:t=>{const{x:i,y:e}=t;this.context.lineTo(i,e),this.context.stroke()},straightLine:t=>{let{x:i,y:e,ft_originX:n,ft_originY:s}=t;this.reDraw(),this.context.moveTo(n,s),this.context.lineTo(i,e),this.context.stroke()},rect:t=>{const{newOriginX:i,newOriginY:e,distanceX:n,distanceY:s}=t;this.reDraw(),this.context.rect(i,e,n,s),this.context.stroke(),this.context.closePath()},circle:t=>{const{newOriginX:i,newOriginY:e,distanceX:n,distanceY:s}=t;this.reDraw();const o=Math.sqrt(n*n+s*s);this.context.arc(i+n,e+s,o,0,2*Math.PI),this.context.stroke()},arrow:t=>{const{x:e,y:n}=t;this.reDraw(),this.arrowPoints[1]={x:e/this.canvasWidth,y:n/this.canvasHeight},i(this.context,{points:this.arrowPoints,arrowSize:this.configuration.arrowSize,canvasWidth:this.canvasWidth,canvasHeight:this.canvasHeight})},eraser:t=>{const{x:i,y:e}=t;this.configuration.bgImg&&(this.context.globalCompositeOperation="destination-out"),this.context.strokeStyle=this.configuration.canvasBgColor,this.context.fillStyle=this.configuration.canvasBgColor,this.context.lineWidth=this.configuration.eraserSize,this.context.lineTo(i,e),this.context.stroke()},clear:()=>this.clear()}}saveArrowPoint(t){this.arrowPoints=[],this.arrowPoints.push({x:t.x/this.canvasWidth,y:t.y/this.canvasHeight})}createTextMeasure(){this.measureEl&&(t.removeChild(this.container,this.measureEl),this.measureEl=null),this.measureEl=t.createEl("pre",{styles:{fontSize:`${this.configuration.textFontSize}px`,lineHeight:`${this.configuration.textLineHeight}px`,color:this.configuration.textColor,fontFamily:this.configuration.fontFamily}}),t.addClass(this.measureEl,"__edb-text-pre"),t.appendChild(this.container,this.measureEl)}drawText(t,i){i.font=i.fontFamily;let e=i.text;t.save(),t.textBaseline="middle",t.font=`${i.textFontSize}px/${i.textLineHeight}px ${i.font}`,t.fillStyle=i.textColor,t.globalCompositeOperation="source-over",e.replace(/<br>/g,"\n").split(/\n/).map(((e,n)=>{t.fillText(e,i.position.x+2,i.position.y+n*i.textLineHeight+i.textLineHeight/2+2)})),t.restore()}createTextArea(i){this.mode=null,this.boxDom&&t.removeChild(this.container,this.boxDom),this.boxDom=t.createEl("div",{styles:{position:"absolute",left:i.x/this.configuration.ratio+"px",top:i.y/this.configuration.ratio+"px",lineHeight:this.configuration.textLineHeight/this.configuration.ratio+"px",fontSize:this.configuration.textFontSize/this.configuration.ratio+"px"}}),t.addClass(this.boxDom,"__edb-textarea-box"),this.textareaEl=t.createEl("textarea",{styles:{color:this.configuration.textColor,lineHeight:this.configuration.textLineHeight/this.configuration.ratio+"px",fontSize:this.configuration.textFontSize/this.configuration.ratio+"px"},props:{placeholder:this.configuration.textareaPlaceholder}}),t.addClass(this.textareaEl,"__edb-textarea"),t.appendChild(this.boxDom,this.textareaEl),t.appendChild(this.container,this.boxDom),setTimeout((()=>{this.textareaEl.focus(),this.textareaEl.onblur=()=>{this.mode=null,this.drawText(this.context,{text:this.textareaEl.value,textColor:this.configuration.textColor,textFontSize:this.configuration.textFontSize,textLineHeight:this.configuration.textLineHeight,position:i,fontFamily:this.configuration.fontFamily}),t.removeChild(this.container,this.boxDom),this.boxDom=null,this.textareaEl=null},this.textareaEl.addEventListener("input",(t=>{this.measureEl.innerHTML=t.target.value+" ",this.textareaEl.style.width=this.measureEl.clientWidth/this.configuration.ratio+"px",this.textareaEl.style.height=this.measureEl.clientHeight/this.configuration.ratio+"px"}))}),50)}resetBgImg(){this.redoQueue.length=0,this.undoQueue.length=0,this.clear(!1),this.setBackground()}config(t,i){switch(["lineWidth","arrowSize","eraserSize","textFontSize","textLineHeight"].includes(t)?this.configuration[t]=i*this.configuration.ratio:this.configuration[t]=i,t){case"canvasBgColor":this.clear(!1);break;case"bgImg":this.resetBgImg();break;case"textFontSize":case"textColor":case"textLineHeight":case"fontFamily":this.createTextMeasure()}}setMode(i){this.context.globalCompositeOperation="source-over",this.context.strokeStyle=this.configuration.lineColor,this.context.fillStyle=this.configuration.lineColor,this.context.lineWidth=this.configuration.lineWidth,"eraser"===i?t.addClass(this.container,"__edb-eraser-hover"):t.removeClass(this.container,"__edb-eraser-hover"),this.mode=i,"circle"==i?t.addClass(this.container,"__edb-pencil-hover"):t.removeClass(this.container,"__edb-pencil-hover")}undo(){let t=this.undoQueue.length;if(0!==t){if(1===t){if(!this.firstDraw)return this.redoQueue.push(this.undoQueue.pop()),void this.clear(!1);this.historyImage.src=this.firstDraw}else this.historyImage.src=this.undoQueue[t-2];this.historyImage.onload=()=>{this.clear(!1),this.context.drawImage(this.historyImage,0,0),this.redoQueue.push(this.undoQueue.pop())}}}redo(){0!==this.redoQueue.length&&(this.undoQueue.push(this.redoQueue.pop()),this.historyImage.src=this.undoQueue[this.undoQueue.length-1],this.historyImage.onload=()=>{this.clear(!1),this.context.drawImage(this.historyImage,0,0)})}generateBase64(t="png"){return new Promise((async i=>{if(this.configuration.bgImg){i(await n(this.canvas,this.configuration.bgImg,t))}else i(this.canvas.toDataURL(`image/${t}`))}))}async saveImg(i={type:"png",fileName:"canvas_image"}){let e=null;e=this.configuration.bgImg?await n(this.canvas,this.configuration.bgImg,i.type):this.canvas.toDataURL(`image/${i.type}`);t.createEl("a",{attrs:{href:e,download:`${i.fileName}.${i.type}`}}).click()}clear(t=!0){if(this.context.fillStyle=this.configuration.canvasBgColor,this.context.fillRect(0,0,this.canvasWidth,this.canvasHeight),this.configuration.bgImg&&(this.context.globalCompositeOperation="destination-out",this.context.fillRect(0,0,this.canvasWidth,this.canvasHeight),this.context.globalCompositeOperation="source-over"),this.undoQueue.length&&t){let t=this.canvas.toDataURL("image/png");this.undoQueue.push(t)}}}export{r as default};
